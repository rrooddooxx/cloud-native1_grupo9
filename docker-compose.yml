services:
  rabbitmq:
    image: rabbitmq:4.1.1-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - ./rabbitmq:/var/lib/rabbitmq
    restart: unless-stopped
  zookeeper-1:
    image: confluentinc/cp-zookeeper
    ports:
      - "32181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
    zookeeper-2:
      image: confluentinc/cp-zookeeper
      ports:
        - "32182:2181"
      environment:
        ZOOKEEPER_CLIENT_PORT: 2181
        ZOOKEEPER_TICK_TIME: 2000
        ZOOKEEPER_SYNC_LIMIT: 2
    zookeeper-3:
      image: confluentinc/cp-zookeeper
      ports:
        - "32183:2181"
      environment:
        ZOOKEEPER_CLIENT_PORT: 2181
        ZOOKEEPER_TICK_TIME: 2000
        ZOOKEEPER_SYNC_LIMIT: 2
    kafka-broker-1:
      image: confluentinc/cp-kafka:7.9.2
      hostname: kafka-broker-1
      container_name: kafka-broker-1
      depends_on:
        - zookeeper-1
        - zookeeper-2
        - zookeeper-3
      ports:
        - "9091:9091"
      environment:
        KAFKA_BROKER_ID: 1
        KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181,zookeeper-2:2181,zookeeper-3:2181
        KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
        KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker-1:29091,PLAINTEXT_HOST://localhost:9091
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    kafka-broker-2:
      image: confluentinc/cp-kafka:7.9.2
      hostname: kafka-broker-2
      container_name: kafka-broker-2
      depends_on:
        - zookeeper-1
        - zookeeper-2
        - zookeeper-3
      ports:
        - "9092:9092"
      environment:
        KAFKA_BROKER_ID: 2
        KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181,zookeeper-2:2181,zookeeper-3:2181
        KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
        KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker-2:29092,PLAINTEXT_HOST://localhost:9092
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    kafka-broker-3:
      image: confluentinc/cp-kafka:7.9.2
      hostname: kafka-broker-3
      container_name: kafka-broker-3
      depends_on:
        - zookeeper-1
        - zookeeper-2
        - zookeeper-3
      ports:
        - "9093:9093"
      environment:
        KAFKA_BROKER_ID: 3
        KAFKA_ZOOKEEPER_CONNECT: zookeeper-1:2181,zookeeper-2:2181,zookeeper-3:2181
        KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
        KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-broker-3:29093,PLAINTEXT_HOST://localhost:9093
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    kafbat-ui:
      container_name: kafbat-ui
      image: ghcr.io/kafbat/kafka-ui:latest
      ports:
        - 8080:8080
      environment:
        DYNAMIC_CONFIG_ENABLED: 'true'
  bff-cn1g9:
    build:
      context: bff
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    ports:
      - "8080:8080"
  products-service:
    depends_on:
      - rabbitmq
    build:
      context: products-ms-cn1-grupo9
      platforms:
        - "linux/amd64"
        - "linux/arm64"
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=${SERVER_PORT:-8080}
      - SPRING_APPLICATION_NAME=cn1-grupo9
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT=org.hibernate.dialect.OracleDialect
      - SPRING_DATASOURCE_URL=jdbc:oracle:thin:@cn1g9_tp?TNS_ADMIN=/app/wallet
      - SPRING_DATASOURCE_USERNAME=CN1G9
      - SPRING_DATASOURCE_PASSWORD=cu'b32i-Eu!}d*S
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=oracle.jdbc.driver.OracleDriver
      - SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE=4
      - SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT=30000
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_ORG_HIBERNATE<=INFO
    volumes:
      - ./wallet:/app/wallet:ro
    restart: unless-stopped
  inventory-ms:

  products-ms:

  sales-ms:

  promotions-ms:
